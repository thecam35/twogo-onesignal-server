<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Twogo - Panel de Administración</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    
    <!-- OneSignal SDK -->
    <script src="https://cdn.onesignal.com/sdks/OneSignalSDK.js" async=""></script>
    
    <style>
        :root {
            --primary: #4a6bff;
            --secondary: #ff6b4a;
            --dark: #333;
            --light: #f8f9fa;
            --gray: #6c757d;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --background: white;
            --text: #333;
            --card-bg: white;
            --input-bg: #f5f5f5;
            --sidebar-bg: #2c3e50;
            --sidebar-hover: #34495e;
            --sidebar-active: #4a6bff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--light);
            color: var(--dark);
            line-height: 1.6;
            overflow-x: hidden;
            min-height: 100vh;
        }
        
        /* Admin Panel Layout */
        .admin-panel {
            display: flex;
            width: 100%;
            min-height: 100vh;
            background: var(--background);
        }

        /* Sidebar Styles */
        .admin-sidebar {
            width: 280px;
            background: var(--sidebar-bg);
            color: white;
            transition: all 0.3s;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }

        .admin-sidebar.collapsed {
            width: 70px;
        }

        .admin-sidebar.collapsed .sidebar-text {
            display: none;
        }

        .admin-sidebar.collapsed .sidebar-logo-text {
            display: none;
        }

        .admin-sidebar.collapsed .sidebar-toggle i {
            transform: rotate(180deg);
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .sidebar-logo {
            width: 40px;
            height: 40px;
            background: var(--primary);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
        }

        .sidebar-logo-text {
            font-size: 18px;
            font-weight: bold;
        }

        .sidebar-menu {
            padding: 15px 0;
        }

        .sidebar-item {
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 4px solid transparent;
        }

        .sidebar-item:hover {
            background: var(--sidebar-hover);
        }

        .sidebar-item.active {
            background: var(--sidebar-active);
            border-left-color: white;
        }

        .sidebar-icon {
            width: 24px;
            text-align: center;
            font-size: 18px;
        }

        .sidebar-text {
            font-weight: 500;
        }

        .sidebar-badge {
            background: var(--danger);
            color: white;
            border-radius: 10px;
            padding: 2px 8px;
            font-size: 12px;
            margin-left: auto;
        }

        .sidebar-toggle {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(255,255,255,0.1);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .sidebar-toggle:hover {
            background: rgba(255,255,255,0.2);
        }

        /* Main Content */
        .admin-main {
            flex: 1;
            margin-left: 280px;
            transition: margin-left 0.3s;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .admin-main.expanded {
            margin-left: 70px;
        }

        .admin-header {
            background: var(--primary);
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .admin-title {
            font-size: 20px;
            font-weight: bold;
        }

        .admin-user {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .user-name {
            font-weight: 500;
        }

        .btn-logout {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .btn-logout:hover {
            background: rgba(255,255,255,0.3);
        }

        .admin-content {
            flex: 1;
            padding: 30px;
            background: var(--light);
            overflow-y: auto;
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Common Section Styles */
        .admin-section {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 2px solid var(--primary);
            padding-bottom: 10px;
        }

        .section-title i {
            color: var(--primary);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-item {
            background: var(--input-bg);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            border-left: 4px solid var(--primary);
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            color: var(--gray);
        }

        /* Driver Applications */
        .pending-drivers-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .driver-application {
            background: var(--input-bg);
            border-radius: 10px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid var(--warning);
        }

        .driver-app-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .driver-app-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
        }

        .driver-app-details {
            flex: 1;
        }

        .driver-app-name {
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--text);
            font-size: 16px;
        }

        .driver-app-phone, .driver-app-email, .driver-app-vehicle {
            color: var(--gray);
            font-size: 14px;
            margin-bottom: 2px;
        }

        .driver-app-actions {
            display: flex;
            gap: 10px;
        }

        .btn-approve {
            background: var(--success);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn-reject {
            background: var(--danger);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn-view-details {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Modal de Detalles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 0;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .modal-header {
            background: var(--primary);
            color: white;
            padding: 20px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 20px;
            font-weight: bold;
        }

        .modal-close {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            cursor: pointer;
        }

        .modal-body {
            padding: 25px;
        }

        /* Grid de Información Personal */
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .info-section {
            background: var(--input-bg);
            border-radius: 10px;
            padding: 20px;
            border-left: 4px solid var(--primary);
        }

        .info-section-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .info-item {
            margin-bottom: 12px;
            display: flex;
            flex-direction: column;
        }

        .info-label {
            font-size: 12px;
            color: var(--gray);
            margin-bottom: 4px;
            font-weight: 500;
        }

        .info-value {
            font-size: 14px;
            color: var(--text);
            font-weight: 600;
        }

        /* Grid de Fotos Elegante */
        .photos-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-top: 30px;
        }

        .photo-section {
            background: var(--input-bg);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }

        .photo-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--primary);
        }

        .photo-container {
            width: 100%;
            height: 200px;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid var(--primary);
            background: var(--card-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .photo-container:hover {
            transform: scale(1.02);
        }

        .photo-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-placeholder {
            color: var(--gray);
            text-align: center;
        }

        .photo-placeholder i {
            font-size: 48px;
            margin-bottom: 10px;
            color: var(--primary);
        }

        /* Verified Drivers */
        .verified-drivers-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
        }

        .verified-driver-card {
            background: var(--input-bg);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            border-left: 4px solid var(--success);
        }

        .verified-driver-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 20px;
            margin: 0 auto 10px;
        }

        .verified-driver-name {
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--text);
            font-size: 16px;
        }

        .verified-driver-email, .verified-driver-vehicle, .verified-driver-plate {
            color: var(--gray);
            font-size: 14px;
            margin-bottom: 5px;
        }

        .verified-driver-status {
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
            margin: 10px 0;
            display: inline-block;
        }

        .verified-driver-status.online {
            background: var(--success);
            color: white;
        }

        .verified-driver-status.offline {
            background: var(--gray);
            color: white;
        }

        .btn-revoke {
            background: var(--danger);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            font-size: 12px;
            cursor: pointer;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            margin-top: 10px;
        }

        /* Notification System */
        .notification-system {
            margin-top: 20px;
        }

        .notification-form {
            background: var(--input-bg);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .notification-form textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--input-bg);
            border-radius: 8px;
            background: var(--card-bg);
            color: var(--text);
            font-size: 14px;
            resize: vertical;
            min-height: 100px;
            margin-bottom: 10px;
        }

        .notification-form textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        .notification-targets {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .notification-target {
            flex: 1;
            padding: 10px;
            background: var(--card-bg);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .notification-target.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .btn-send-notification {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-send-notification:hover {
            background: #3a5bef;
        }

        /* Blacklist Section */
        .blacklist-section {
            margin-top: 20px;
        }

        .blacklist-form {
            background: var(--input-bg);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .blacklist-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .blacklist-input-group input {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--input-bg);
            border-radius: 8px;
            background: var(--card-bg);
            color: var(--text);
        }

        .blacklist-input-group input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .btn-add-blacklist {
            background: var(--danger);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
        }

        .blacklist-items {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .blacklist-item {
            background: var(--input-bg);
            border-radius: 8px;
            padding: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid var(--danger);
        }

        .blacklist-plate {
            font-weight: 600;
            color: var(--text);
            font-size: 16px;
        }

        .blacklist-reason {
            color: var(--gray);
            font-size: 14px;
        }

        .btn-remove-blacklist {
            background: var(--danger);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Empty States */
        .no-applications {
            text-align: center;
            padding: 40px 20px;
            color: var(--gray);
        }

        .no-applications i {
            font-size: 48px;
            margin-bottom: 15px;
            color: var(--primary);
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .toast {
            background: var(--card-bg);
            color: var(--text);
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 12px;
            max-width: 350px;
            transform: translateX(400px);
            opacity: 0;
            transition: all 0.4s;
            border-left: 4px solid var(--primary);
        }
        
        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }
        
        .toast.success {
            border-left-color: var(--success);
        }
        
        .toast.warning {
            border-left-color: var(--warning);
        }
        
        .toast.error {
            border-left-color: var(--danger);
        }
        
        .toast-icon {
            font-size: 20px;
        }
        
        .toast-content {
            flex: 1;
        }
        
        .toast-title {
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .toast-message {
            font-size: 14px;
            color: var(--gray);
        }

        /* Loading Spinner */
        .loading {
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: var(--primary);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Earnings and Payment System Styles */
        .earnings-section {
            margin-top: 20px;
        }

        .earnings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .earning-item {
            background: var(--input-bg);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            border-left: 4px solid var(--primary);
        }

        .earning-value {
            font-size: 18px;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .earning-label {
            font-size: 12px;
            color: var(--gray);
        }

        /* Receipts Section */
        .receipts-section {
            margin-top: 20px;
        }

        .receipts-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .receipt-item {
            background: var(--input-bg);
            border-radius: 10px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid var(--primary);
        }

        .receipt-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .receipt-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
        }

        .receipt-details {
            flex: 1;
        }

        .receipt-driver-name {
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--text);
            font-size: 16px;
        }

        .receipt-amount, .receipt-date {
            color: var(--gray);
            font-size: 14px;
            margin-bottom: 2px;
        }

        .receipt-actions {
            display: flex;
            gap: 10px;
        }

        .btn-view-receipt {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn-approve-receipt {
            background: var(--success);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn-reject-receipt {
            background: var(--danger);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Receipt Modal */
        .receipt-modal-content {
            max-width: 600px;
        }

        .receipt-image-container {
            width: 100%;
            max-height: 400px;
            overflow: hidden;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .receipt-image {
            width: 100%;
            height: auto;
            object-fit: contain;
        }

        .receipt-details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .receipt-detail-item {
            display: flex;
            flex-direction: column;
        }

        .receipt-detail-label {
            font-size: 12px;
            color: var(--gray);
            margin-bottom: 4px;
            font-weight: 500;
        }

        .receipt-detail-value {
            font-size: 14px;
            color: var(--text);
            font-weight: 600;
        }

        .receipt-actions-modal {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        /* Nuevos estilos para solicitudes de créditos */
        .credits-requests-section {
            margin-top: 20px;
        }

        .credits-requests-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .credits-request-item {
            background: var(--input-bg);
            border-radius: 10px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid var(--warning);
        }

        .credits-request-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .credits-request-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
        }

        .credits-request-details {
            flex: 1;
        }

        .credits-request-driver-name {
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--text);
            font-size: 16px;
        }

        .credits-request-amount, .credits-request-account, .credits-request-date {
            color: var(--gray);
            font-size: 14px;
            margin-bottom: 2px;
        }

        .credits-request-actions {
            display: flex;
            gap: 10px;
        }

        .btn-view-credits-details {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn-approve-credits {
            background: var(--success);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn-reject-credits {
            background: var(--danger);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Credits Modal */
        .credits-modal-content {
            max-width: 600px;
        }

        .credits-details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .credits-detail-item {
            display: flex;
            flex-direction: column;
        }

        .credits-detail-label {
            font-size: 12px;
            color: var(--gray);
            margin-bottom: 4px;
            font-weight: 500;
        }

        .credits-detail-value {
            font-size: 14px;
            color: var(--text);
            font-weight: 600;
        }

        .credits-actions-modal {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        /* Chat System Styles */
        .chat-container {
            display: flex;
            gap: 20px;
            height: 600px;
        }

        .chat-sidebar {
            width: 300px;
            background: var(--card-bg);
            border-radius: 10px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .chat-sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--input-bg);
        }

        .chat-sidebar-title {
            font-weight: 600;
            color: var(--text);
        }

        .chat-controls {
            display: flex;
            gap: 10px;
        }

        .chat-control-btn {
            background: var(--primary);
            color: white;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            cursor: pointer;
        }

        .active-chats-list {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .active-chat-item {
            background: var(--input-bg);
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 4px solid var(--primary);
        }

        .active-chat-item:hover {
            background: #e9ecef;
        }

        .active-chat-item.active {
            background: var(--primary);
            color: white;
        }

        .chat-user-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .chat-last-message {
            font-size: 12px;
            color: var(--gray);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .active-chat-item.active .chat-last-message {
            color: rgba(255,255,255,0.8);
        }

        .chat-unread-count {
            background: var(--danger);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
        }

        .chat-main {
            flex: 1;
            background: var(--card-bg);
            border-radius: 10px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--input-bg);
        }

        .chat-header-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chat-user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 16px;
        }

        .chat-user-details {
            display: flex;
            flex-direction: column;
        }

        .chat-user-status {
            font-size: 12px;
            color: var(--gray);
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 10px;
            background: var(--input-bg);
            border-radius: 8px;
        }

        .chat-message {
            max-width: 80%;
            padding: 10px 12px;
            border-radius: 12px;
            position: relative;
            word-wrap: break-word;
            font-size: 14px;
        }

        .chat-message.user {
            align-self: flex-start;
            background: var(--card-bg);
            color: var(--text);
            border-bottom-left-radius: 5px;
        }

        .chat-message.admin {
            align-self: flex-end;
            background: var(--primary);
            color: white;
            border-bottom-right-radius: 5px;
        }

        .message-time {
            font-size: 10px;
            opacity: 0.7;
            margin-top: 5px;
            text-align: right;
        }

        .chat-input-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .chat-input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid var(--input-bg);
            border-radius: 25px;
            background: var(--card-bg);
            color: var(--text);
            font-size: 14px;
            resize: none;
            outline: none;
        }

        .chat-input:focus {
            border-color: var(--primary);
        }

        .btn-send-chat {
            background: var(--primary);
            color: white;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            cursor: pointer;
        }

        .no-messages {
            text-align: center;
            color: var(--gray);
            padding: 40px 20px;
        }

        .no-messages i {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .chat-status {
            text-align: center;
            font-size: 12px;
            color: var(--gray);
            margin-bottom: 10px;
        }

        .chat-status.typing {
            color: var(--primary);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .admin-sidebar {
                width: 70px;
            }
            
            .admin-sidebar .sidebar-text {
                display: none;
            }
            
            .admin-sidebar .sidebar-logo-text {
                display: none;
            }
            
            .admin-main {
                margin-left: 70px;
            }
            
            .chat-container {
                flex-direction: column;
                height: auto;
            }
            
            .chat-sidebar {
                width: 100%;
                height: 200px;
            }
            
            .chat-main {
                height: 400px;
            }
        }
    </style>
</head>
<body>
    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <!-- Modal de Detalles -->
    <div class="modal-overlay" id="details-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Detalles Completos del Conductor</div>
                <button class="modal-close" id="modal-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="modal-body">
                <!-- Los detalles se cargarán aquí dinámicamente -->
            </div>
        </div>
    </div>

    <!-- Modal de Comprobante -->
    <div class="modal-overlay" id="receipt-modal">
        <div class="modal-content receipt-modal-content">
            <div class="modal-header">
                <div class="modal-title">Comprobante de Pago</div>
                <button class="modal-close" id="receipt-modal-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="receipt-modal-body">
                <!-- Los detalles del comprobante se cargarán aquí dinámicamente -->
            </div>
        </div>
    </div>

    <!-- Modal de Solicitud de Créditos -->
    <div class="modal-overlay" id="credits-modal">
        <div class="modal-content credits-modal-content">
            <div class="modal-header">
                <div class="modal-title">Solicitud de Cobro de Créditos</div>
                <button class="modal-close" id="credits-modal-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="credits-modal-body">
                <!-- Los detalles de la solicitud de créditos se cargarán aquí dinámicamente -->
            </div>
        </div>
    </div>

    <!-- Admin Panel -->
    <div class="admin-panel" id="admin-panel">
        <!-- Sidebar -->
        <div class="admin-sidebar" id="admin-sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">T</div>
                <div class="sidebar-logo-text">Twogo Admin</div>
            </div>
            
            <div class="sidebar-menu">
                <div class="sidebar-item active" data-section="dashboard">
                    <div class="sidebar-icon">
                        <i class="fas fa-tachometer-alt"></i>
                    </div>
                    <div class="sidebar-text">Dashboard</div>
                </div>
                
                <div class="sidebar-item" data-section="drivers">
                    <div class="sidebar-icon">
                        <i class="fas fa-user-clock"></i>
                    </div>
                    <div class="sidebar-text">Solicitudes Pendientes</div>
                    <div class="sidebar-badge" id="pending-drivers-count">0</div>
                </div>
                
                <div class="sidebar-item" data-section="verified-drivers">
                    <div class="sidebar-icon">
                        <i class="fas fa-user-check"></i>
                    </div>
                    <div class="sidebar-text">Conductores Verificados</div>
                </div>
                
                <div class="sidebar-item" data-section="earnings">
                    <div class="sidebar-icon">
                        <i class="fas fa-money-bill-wave"></i>
                    </div>
                    <div class="sidebar-text">Ganancias</div>
                </div>
                
                <div class="sidebar-item" data-section="credits">
                    <div class="sidebar-icon">
                        <i class="fas fa-coins"></i>
                    </div>
                    <div class="sidebar-text">Solicitudes de Créditos</div>
                    <div class="sidebar-badge" id="pending-credits-count">0</div>
                </div>
                
                <div class="sidebar-item" data-section="chat">
                    <div class="sidebar-icon">
                        <i class="fas fa-comments"></i>
                    </div>
                    <div class="sidebar-text">Chat de Soporte</div>
                    <div class="sidebar-badge" id="unread-chats-count">0</div>
                </div>
                
                <div class="sidebar-item" data-section="notifications">
                    <div class="sidebar-icon">
                        <i class="fas fa-bell"></i>
                    </div>
                    <div class="sidebar-text">Notificaciones</div>
                </div>
                
                <div class="sidebar-item" data-section="blacklist">
                    <div class="sidebar-icon">
                        <i class="fas fa-ban"></i>
                    </div>
                    <div class="sidebar-text">Lista Negra</div>
                </div>
            </div>
            
            <button class="sidebar-toggle" id="sidebar-toggle">
                <i class="fas fa-chevron-left"></i>
            </button>
        </div>
        
        <!-- Main Content -->
        <div class="admin-main" id="admin-main">
            <div class="admin-header">
                <div class="admin-title">Panel de Administración - Twogo Cartagena</div>
                <div class="admin-user">
                    <div class="user-avatar" id="user-avatar">A</div>
                    <div class="user-name" id="user-name">Administrador</div>
                    <button class="btn-logout" id="btn-logout">
                        <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
                    </button>
                </div>
            </div>
            
            <div class="admin-content">
                <!-- Dashboard Section -->
                <div class="content-section active" id="dashboard-section">
                    <div class="admin-section">
                        <div class="section-title">
                            <i class="fas fa-chart-line"></i>
                            Estadísticas de la Plataforma
                        </div>
                        
                        <div class="stats-grid">
                            <div class="stat-item">
                                <div class="stat-value" id="total-users">0</div>
                                <div class="stat-label">Usuarios Totales</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="active-drivers">0</div>
                                <div class="stat-label">Conductores Activos</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="today-rides">0</div>
                                <div class="stat-label">Viajes Hoy</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="total-earnings">$0</div>
                                <div class="stat-label">Ganancias Totales</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="admin-section">
                        <div class="section-title">
                            <i class="fas fa-exclamation-circle"></i>
                            Alertas y Pendientes
                        </div>
                        
                        <div class="stats-grid">
                            <div class="stat-item" style="border-left-color: var(--warning);">
                                <div class="stat-value" id="pending-applications">0</div>
                                <div class="stat-label">Solicitudes Pendientes</div>
                            </div>
                            <div class="stat-item" style="border-left-color: var(--warning);">
                                <div class="stat-value" id="pending-receipts">0</div>
                                <div class="stat-label">Comprobantes Pendientes</div>
                            </div>
                            <div class="stat-item" style="border-left-color: var(--warning);">
                                <div class="stat-value" id="pending-credits">0</div>
                                <div class="stat-label">Solicitudes de Créditos</div>
                            </div>
                            <div class="stat-item" style="border-left-color: var(--danger);">
                                <div class="stat-value" id="unread-chats">0</div>
                                <div class="stat-label">Chats Sin Leer</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Drivers Section -->
                <div class="content-section" id="drivers-section">
                    <div class="admin-section">
                        <div class="section-title">
                            <i class="fas fa-user-clock"></i>
                            Solicitudes de Conductores Pendientes
                        </div>
                        
                        <div class="pending-drivers-list" id="pending-drivers-list">
                            <div class="loading">
                                <div class="spinner"></div>
                                <div>Cargando solicitudes...</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Verified Drivers Section -->
                <div class="content-section" id="verified-drivers-section">
                    <div class="admin-section">
                        <div class="section-title">
                            <i class="fas fa-user-check"></i>
                            Conductores Verificados
                        </div>
                        
                        <div class="verified-drivers-list" id="verified-drivers-list">
                            <div class="loading">
                                <div class="spinner"></div>
                                <div>Cargando conductores...</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Earnings Section -->
                <div class="content-section" id="earnings-section">
                    <div class="admin-section">
                        <div class="section-title">
                            <i class="fas fa-money-bill-wave"></i>
                            Sistema de Ganancias y Comprobantes
                        </div>
                        
                        <!-- Estadísticas de Ganancias -->
                        <div class="earnings-section">
                            <div class="earnings-grid">
                                <div class="earning-item">
                                    <div class="earning-value" id="total-earnings-today">$0</div>
                                    <div class="earning-label">Ganancias Hoy</div>
                                </div>
                                <div class="earning-item">
                                    <div class="earning-value" id="total-payments-pending">$0</div>
                                    <div class="earning-label">Pagos Pendientes</div>
                                </div>
                                <div class="earning-item">
                                    <div class="earning-value" id="total-comissions">$0</div>
                                    <div class="earning-label">Comisiones Twogo</div>
                                </div>
                                <div class="earning-item">
                                    <div class="earning-value" id="total-receipts-pending">0</div>
                                    <div class="earning-label">Comprobantes Pendientes</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Comprobantes Pendientes -->
                        <div class="receipts-section">
                            <div class="section-title">
                                <i class="fas fa-receipt"></i>
                                Comprobantes Pendientes de Verificación
                            </div>
                            
                            <div class="receipts-list" id="pending-receipts-list">
                                <div class="loading">
                                    <div class="spinner"></div>
                                    <div>Cargando comprobantes...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Credits Section -->
                <div class="content-section" id="credits-section">
                    <div class="admin-section">
                        <div class="section-title">
                            <i class="fas fa-coins"></i>
                            Solicitudes de Cobro de Créditos
                        </div>
                        
                        <div class="credits-requests-section">
                            <div class="credits-requests-list" id="pending-credits-list">
                                <div class="loading">
                                    <div class="spinner"></div>
                                    <div>Cargando solicitudes de créditos...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Chat Section -->
                <div class="content-section" id="chat-section">
                    <div class="admin-section">
                        <div class="section-title">
                            <i class="fas fa-comments"></i>
                            Chat de Soporte en Tiempo Real
                        </div>
                        
                        <div class="chat-container">
                            <div class="chat-sidebar">
                                <div class="chat-sidebar-header">
                                    <div class="chat-sidebar-title">Chats Activos</div>
                                    <div class="chat-controls">
                                        <button class="chat-control-btn" id="btn-refresh-chats">
                                            <i class="fas fa-sync-alt"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="active-chats-list" id="active-chats-list">
                                    <div class="loading">
                                        <div class="spinner"></div>
                                        <div>Cargando chats...</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="chat-main">
                                <div class="chat-header">
                                    <div class="chat-header-info">
                                        <div class="chat-user-avatar" id="current-chat-avatar">?</div>
                                        <div class="chat-user-details">
                                            <div class="chat-user-name" id="current-chat-name">Selecciona un chat</div>
                                            <div class="chat-user-status" id="current-chat-status">Para comenzar la conversación</div>
                                        </div>
                                    </div>
                                    <div class="chat-controls">
                                        <button class="chat-control-btn" id="btn-clear-chat">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="chat-messages" id="chat-messages">
                                    <div class="no-messages">
                                        <i class="fas fa-comments"></i>
                                        <div>No hay mensajes aún</div>
                                        <div style="font-size: 14px; margin-top: 10px;">Selecciona un chat para ver los mensajes</div>
                                    </div>
                                </div>
                                
                                <div class="chat-input-container">
                                    <input type="text" class="chat-input" id="chat-input" placeholder="Escribe tu mensaje..." disabled>
                                    <button class="btn-send-chat" id="btn-send-chat" disabled>
                                        <i class="fas fa-paper-plane"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Notifications Section -->
                <div class="content-section" id="notifications-section">
                    <div class="admin-section">
                        <div class="section-title">
                            <i class="fas fa-bell"></i>
                            Sistema de Notificaciones
                        </div>
                        
                        <div class="notification-system">
                            <div class="notification-form">
                                <textarea id="notification-message" placeholder="Escribe tu mensaje de notificación aquí..."></textarea>
                                
                                <div class="notification-targets">
                                    <div class="notification-target active" data-target="all">
                                        <i class="fas fa-users"></i>
                                        Todos los Usuarios
                                    </div>
                                    <div class="notification-target" data-target="passengers">
                                        <i class="fas fa-user"></i>
                                        Solo Pasajeros
                                    </div>
                                    <div class="notification-target" data-target="drivers">
                                        <i class="fas fa-car"></i>
                                        Solo Conductores
                                    </div>
                                </div>
                                
                                <button class="btn-send-notification" id="btn-send-notification">
                                    <i class="fas fa-paper-plane"></i> Enviar Notificación
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Blacklist Section -->
                <div class="content-section" id="blacklist-section">
                    <div class="admin-section">
                        <div class="section-title">
                            <i class="fas fa-ban"></i>
                            Lista Negra de Placas
                        </div>
                        
                        <div class="blacklist-section">
                            <div class="blacklist-form">
                                <div class="blacklist-input-group">
                                    <input type="text" id="blacklist-plate" placeholder="Ingresa la placa (ej: ABC123)" style="text-transform: uppercase;">
                                    <input type="text" id="blacklist-reason" placeholder="Motivo de la restricción">
                                </div>
                                <button class="btn-add-blacklist" id="btn-add-blacklist">
                                    <i class="fas fa-plus"></i> Agregar a Lista Negra
                                </button>
                            </div>
                            
                            <div class="blacklist-items" id="blacklist-items">
                                <div class="loading">
                                    <div class="spinner"></div>
                                    <div>Cargando lista negra...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== CONFIGURACIÓN ONESIGNAL ==========
        window.OneSignal = window.OneSignal || [];
OneSignal.push(function() {
    OneSignal.init({
        appId: "f8865b25-29e8-48e8-a5d5-b54e69098a2e",
        safari_web_id: "web.onesignal.auto.7cdfwjjj-5beo-rjov-wvhg-scmkf2zy64n6",
        notifyButton: {
            enable: false,
        },
        allowLocalhostAsSecureOrigin: true,
    });
})

        // ========== CONFIGURACIÓN FIREBASE ==========
        const firebaseConfig = {
            apiKey: "AIzaSyB9DUMhRktbGski6YYA3-SeiAMuWg4ZJN0",
            authDomain: "twogo-76e62.firebaseapp.com",
            databaseURL: "https://twogo-76e62-default-rtdb.firebaseio.com",
            projectId: "twogo-76e62",
            storageBucket: "twogo-76e62.firebasestorage.app",
            messagingSenderId: "83126867601",
            appId: "1:83126867601:web:5f81cd1492dc452de61130",
            measurementId: "G-10VW270YWQ"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Variables globales
        let adminData = null;
        let chatListener = null;
        let currentChatId = null;
        let activeChatsListener = null;
        let unreadChatsCount = 0;

        // ========== FUNCIONES DE NAVEGACIÓN ==========
        
        // Inicializar navegación del sidebar
        function setupNavigation() {
            // Event listeners para items del sidebar
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.addEventListener('click', function() {
                    const section = this.getAttribute('data-section');
                    showSection(section);
                    
                    // Actualizar clase activa
                    document.querySelectorAll('.sidebar-item').forEach(i => {
                        i.classList.remove('active');
                    });
                    this.classList.add('active');
                });
            });
            
            // Toggle sidebar
            document.getElementById('sidebar-toggle').addEventListener('click', function() {
                const sidebar = document.getElementById('admin-sidebar');
                const main = document.getElementById('admin-main');
                
                sidebar.classList.toggle('collapsed');
                main.classList.toggle('expanded');
                
                // Cambiar icono
                const icon = this.querySelector('i');
                if (sidebar.classList.contains('collapsed')) {
                    icon.classList.remove('fa-chevron-left');
                    icon.classList.add('fa-chevron-right');
                } else {
                    icon.classList.remove('fa-chevron-right');
                    icon.classList.add('fa-chevron-left');
                }
            });
            
            // Botón de cerrar sesión
            document.getElementById('btn-logout').addEventListener('click', function() {
                if (confirm('¿Estás seguro de que deseas cerrar sesión?')) {
                    auth.signOut().then(() => {
                        window.location.href = 'index.html';
                    });
                }
            });
        }
        
        // Mostrar sección específica
        function showSection(sectionId) {
            // Ocultar todas las secciones
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Mostrar sección seleccionada
            document.getElementById(`${sectionId}-section`).classList.add('active');
            
            // Cargar datos específicos de la sección si es necesario
            switch(sectionId) {
                case 'dashboard':
                    loadDashboardStats();
                    break;
                case 'drivers':
                    loadPendingDriverApplications();
                    break;
                case 'verified-drivers':
                    loadVerifiedDrivers();
                    break;
                case 'earnings':
                    loadEarningsStats();
                    loadPendingReceipts();
                    break;
                case 'credits':
                    loadPendingCreditsRequests();
                    break;
                case 'chat':
                    loadActiveChats();
                    break;
                case 'notifications':
                    // Ya está configurado
                    break;
                case 'blacklist':
                    loadBlacklist();
                    break;
            }
        }
        
        // Actualizar contadores en el sidebar
        function updateSidebarCounters() {
            // Solicitudes pendientes
            db.collection('driverApplications')
                .where('status', '==', 'pending')
                .get()
                .then((querySnapshot) => {
                    document.getElementById('pending-drivers-count').textContent = querySnapshot.size;
                    document.getElementById('pending-applications').textContent = querySnapshot.size;
                });
            
            // Solicitudes de créditos
            db.collection('paymentRequests')
                .where('status', '==', 'pending')
                .where('type', '==', 'credits_payment')
                .get()
                .then((querySnapshot) => {
                    document.getElementById('pending-credits-count').textContent = querySnapshot.size;
                    document.getElementById('pending-credits').textContent = querySnapshot.size;
                });
            
            // Comprobantes pendientes
            db.collection('payments')
                .where('status', '==', 'pending_approval')
                .get()
                .then((querySnapshot) => {
                    document.getElementById('pending-receipts').textContent = querySnapshot.size;
                });
            
            // Chats no leídos
            document.getElementById('unread-chats-count').textContent = unreadChatsCount;
            document.getElementById('unread-chats').textContent = unreadChatsCount;
        }

        // ========== FUNCIONES DE NOTIFICACIONES ==========
        function showToast(title, message, type = 'info', duration = 5000) {
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            let icon = 'fas fa-info-circle';
            if (type === 'success') icon = 'fas fa-check-circle';
            if (type === 'warning') icon = 'fas fa-exclamation-triangle';
            if (type === 'error') icon = 'fas fa-times-circle';
            
            toast.innerHTML = `
                <div class="toast-icon">
                    <i class="${icon}"></i>
                </div>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
            `;
            
            toastContainer.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);
            
            if (duration > 0) {
                setTimeout(() => {
                    hideToast(toast);
                }, duration);
            }
            
            return toast;
        }
        
        function hideToast(toast) {
            toast.classList.remove('show');
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 400);
        }

        // ========== CONFIGURACIÓN DEL SERVIDOR ONESIGNAL ==========

async function sendPushNotification(title, message, target = 'all', data = {}) {
    console.log(`📢 Enviando notificación push: ${title} - ${message} a ${target}`);
    
    try {
        const response = await fetch(`${ONESIGNAL_SERVER_URL}/api/send-notification`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                title: title,
                message: message,
                target: target,
                data: data
            })
        });

        const result = await response.json();

        if (result.success) {
            console.log('✅ Notificación push enviada:', result);
            showToast('📢 Notificación Enviada', 'La notificación push se ha enviado correctamente', 'success');
            return result;
        } else {
            console.error('❌ Error enviando notificación push:', result.error);
            showToast('❌ Error', 'No se pudo enviar la notificación push: ' + result.error, 'error');
            return null;
        }
    } catch (error) {
        console.error('❌ Error de conexión:', error);
        showToast('❌ Error', 'Error de conexión con el servidor de notificaciones', 'error');
        return null;
    }
}

        // ========== SISTEMA DE CHAT EN TIEMPO REAL ==========

        // Cargar chats activos
        function loadActiveChats() {
            console.log('💬 Cargando chats activos...');
            const activeChatsList = document.getElementById('active-chats-list');
            
            activeChatsList.innerHTML = '<div class="loading"><div class="spinner"></div><div>Cargando chats...</div></div>';
            
            // Obtener todos los chats
            db.collection('chats')
                .orderBy('lastMessageAt', 'desc')
                .limit(20)
                .get()
                .then((querySnapshot) => {
                    if (querySnapshot.empty) {
                        activeChatsList.innerHTML = `
                            <div class="no-applications">
                                <i class="fas fa-comments"></i>
                                <div>No hay chats activos</div>
                                <small>Los chats aparecerán aquí cuando los usuarios envíen mensajes</small>
                            </div>
                        `;
                        return;
                    }
                    
                    activeChatsList.innerHTML = '';
                    unreadChatsCount = 0;
                    
                    querySnapshot.forEach((doc) => {
                        const chat = doc.data();
                        chat.id = doc.id;
                        
                        // Contar chats no leídos
                        if (chat.unreadCount > 0) {
                            unreadChatsCount += chat.unreadCount;
                        }
                        
                        const chatElement = createActiveChatElement(chat);
                        activeChatsList.appendChild(chatElement);
                    });
                    
                    // Actualizar contador en sidebar
                    updateSidebarCounters();
                    
                    // Configurar listener en tiempo real para chats
                    setupActiveChatsListener();
                })
                .catch((error) => {
                    console.error('Error cargando chats:', error);
                    activeChatsList.innerHTML = `
                        <div class="no-applications">
                            <i class="fas fa-exclamation-triangle"></i>
                            <div>Error cargando chats</div>
                            <small>${error.message}</small>
                        </div>
                    `;
                });
        }

        // Crear elemento de chat activo
        function createActiveChatElement(chat) {
            const element = document.createElement('div');
            element.className = 'active-chat-item';
            element.setAttribute('data-chat-id', chat.id);
            
            const userName = chat.userName || 'Usuario';
            const userEmail = chat.userEmail || 'Sin email';
            const initials = userName.split(' ').map(n => n[0]).join('').toUpperCase();
            const lastMessage = chat.lastMessage || 'No hay mensajes';
            const lastMessageTime = chat.lastMessageAt ? 
                chat.lastMessageAt.toDate().toLocaleTimeString('es-CO', { hour: '2-digit', minute: '2-digit' }) : '';
            
            element.innerHTML = `
                <div class="chat-user-name">${userName}</div>
                <div class="chat-last-message">${lastMessage}</div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 5px;">
                    <small>${lastMessageTime}</small>
                    ${chat.unreadCount > 0 ? `<div class="chat-unread-count">${chat.unreadCount}</div>` : ''}
                </div>
            `;
            
            // Event listener para seleccionar chat
            element.addEventListener('click', function() {
                selectChat(chat.id, userName, userEmail);
            });
            
            return element;
        }

        // Configurar listener en tiempo real para chats activos
        function setupActiveChatsListener() {
            if (activeChatsListener) {
                activeChatsListener();
            }
            
            activeChatsListener = db.collection('chats')
                .orderBy('lastMessageAt', 'desc')
                .onSnapshot((snapshot) => {
                    const activeChatsList = document.getElementById('active-chats-list');
                    activeChatsList.innerHTML = '';
                    unreadChatsCount = 0;
                    
                    snapshot.forEach((doc) => {
                        const chat = doc.data();
                        chat.id = doc.id;
                        
                        // Contar chats no leídos
                        if (chat.unreadCount > 0) {
                            unreadChatsCount += chat.unreadCount;
                        }
                        
                        const chatElement = createActiveChatElement(chat);
                        activeChatsList.appendChild(chatElement);
                    });
                    
                    // Actualizar contador en sidebar
                    updateSidebarCounters();
                    
                    if (snapshot.empty) {
                        activeChatsList.innerHTML = `
                            <div class="no-applications">
                                <i class="fas fa-comments"></i>
                                <div>No hay chats activos</div>
                                <small>Los chats aparecerán aquí cuando los usuarios envíen mensajes</small>
                            </div>
                        `;
                    }
                }, (error) => {
                    console.error('Error en listener de chats:', error);
                });
        }

        // Seleccionar chat
        function selectChat(chatId, userName, userEmail) {
            console.log(`💬 Seleccionando chat: ${chatId}`);
            
            // Remover clase activa de todos los chats
            document.querySelectorAll('.active-chat-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Agregar clase activa al chat seleccionado
            const selectedChat = document.querySelector(`[data-chat-id="${chatId}"]`);
            if (selectedChat) {
                selectedChat.classList.add('active');
            }
            
            // Actualizar información del chat actual
            document.getElementById('current-chat-name').textContent = userName;
            document.getElementById('current-chat-status').textContent = userEmail;
            document.getElementById('current-chat-avatar').textContent = 
                userName.split(' ').map(n => n[0]).join('').toUpperCase();
            
            // Habilitar entrada de chat
            document.getElementById('chat-input').disabled = false;
            document.getElementById('btn-send-chat').disabled = false;
            document.getElementById('chat-input').placeholder = `Escribe un mensaje para ${userName}...`;
            
            // Cargar mensajes del chat
            loadChatMessages(chatId, userName, userEmail);
            
            // Marcar mensajes como leídos
            markMessagesAsRead(chatId);
        }

        // Cargar mensajes del chat
        function loadChatMessages(chatId, userName = '', userEmail = '') {
            console.log(`📨 Cargando mensajes del chat: ${chatId}`);
            
            currentChatId = chatId;
            const chatMessages = document.getElementById('chat-messages');
            chatMessages.innerHTML = '<div class="loading"><div class="spinner"></div><div>Cargando mensajes...</div></div>';
            
            // Detener listener anterior si existe
            if (chatListener) {
                chatListener();
            }
            
            // Configurar listener en tiempo real para mensajes
            chatListener = db.collection('chats').doc(chatId)
                .collection('messages')
                .orderBy('timestamp', 'asc')
                .onSnapshot((snapshot) => {
                    chatMessages.innerHTML = '';
                    
                    if (snapshot.empty) {
                        chatMessages.innerHTML = `
                            <div class="no-messages">
                                <i class="fas fa-comments"></i>
                                <div>No hay mensajes aún</div>
                                <div style="font-size: 14px; margin-top: 10px;">Envía un mensaje para iniciar la conversación</div>
                            </div>
                        `;
                        return;
                    }
                    
                    snapshot.forEach((doc) => {
                        const message = doc.data();
                        const messageElement = createChatMessageElement(message);
                        chatMessages.appendChild(messageElement);
                    });
                    
                    // Scroll al final
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                    
                    // Marcar mensajes como leídos
                    markMessagesAsRead(chatId);
                }, (error) => {
                    console.error('Error en listener del chat:', error);
                    chatMessages.innerHTML = `
                        <div class="no-messages">
                            <i class="fas fa-exclamation-triangle"></i>
                            <div>Error cargando mensajes</div>
                            <small>${error.message}</small>
                        </div>
                    `;
                });
        }

        // Crear elemento de mensaje de chat
        function createChatMessageElement(message) {
            const element = document.createElement('div');
            element.className = `chat-message ${message.sender === 'admin' ? 'admin' : 'user'}`;
            
            const time = message.timestamp ? 
                message.timestamp.toDate().toLocaleTimeString('es-CO', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                }) : 'Ahora';
            
            element.innerHTML = `
                <div class="message-text">${message.text}</div>
                <div class="message-time">${time} - ${message.sender === 'admin' ? 'Admin' : 'Usuario'}</div>
            `;
            
            return element;
        }

        // Enviar mensaje de chat
        function sendChatMessage() {
            const messageInput = document.getElementById('chat-input');
            const messageText = messageInput.value.trim();
            
            if (!messageText) {
                showToast('❌ Error', 'Por favor, escribe un mensaje', 'error');
                return;
            }
            
            if (!currentChatId) {
                showToast('❌ Error', 'No hay chat seleccionado', 'error');
                return;
            }
            
            const user = auth.currentUser;
            if (!user) {
                showToast('❌ Error', 'Debes iniciar sesión para enviar mensajes', 'error');
                return;
            }
            
            // Crear mensaje
            const message = {
                text: messageText,
                sender: 'admin',
                senderId: user.uid,
                senderName: adminData.displayName || 'Administrador',
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            // Guardar mensaje
            db.collection('chats').doc(currentChatId)
                .collection('messages')
                .add(message)
                .then(() => {
                    // Actualizar último mensaje
                    db.collection('chats').doc(currentChatId).update({
                        lastMessage: messageText,
                        lastMessageAt: firebase.firestore.FieldValue.serverTimestamp(),
                        status: 'open',
                        unreadCount: 0 // Resetear contador de no leídos
                    });
                    
                    // Limpiar input
                    messageInput.value = '';
                    
                    // Scroll al final
                    const chatMessages = document.getElementById('chat-messages');
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                    
                    // Enviar notificación al usuario
                    sendNotificationToUser(currentChatId, messageText);
                })
                .catch((error) => {
                    console.error('Error enviando mensaje:', error);
                    showToast('❌ Error', 'No se pudo enviar el mensaje', 'error');
                });
        }

        // Marcar mensajes como leídos
        function markMessagesAsRead(chatId) {
            // Actualizar el chat para marcar mensajes como leídos
            db.collection('chats').doc(chatId).update({
                unreadCount: 0
            }).then(() => {
                // Actualizar contador global
                unreadChatsCount = 0;
                updateSidebarCounters();
            }).catch((error) => {
                console.error('Error marcando mensajes como leídos:', error);
            });
        }

        // Enviar notificación al usuario
        function sendNotificationToUser(chatId, message) {
            // Obtener información del chat
            db.collection('chats').doc(chatId).get()
                .then((doc) => {
                    if (doc.exists) {
                        const chat = doc.data();
                        const userId = chat.userId;
                        
                        // Guardar notificación para el usuario
                        return db.collection('userNotifications').add({
                            userId: userId,
                            type: 'support_message',
                            title: 'Nuevo mensaje de soporte',
                            message: `El administrador te ha enviado un mensaje: "${message.substring(0, 100)}..."`,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            read: false,
                            chatId: chatId
                        });
                    }
                })
                .then(() => {
                    console.log('✅ Notificación enviada al usuario');
                })
                .catch((error) => {
                    console.error('Error enviando notificación al usuario:', error);
                });
        }

        // Limpiar chat
        function clearChat(chatId) {
            if (!chatId) return;
            
            if (confirm('¿Estás seguro de que deseas limpiar este chat? Se eliminarán todos los mensajes.')) {
                // Obtener todos los mensajes del chat
                db.collection('chats').doc(chatId)
                    .collection('messages')
                    .get()
                    .then((querySnapshot) => {
                        const batch = db.batch();
                        
                        querySnapshot.forEach((doc) => {
                            batch.delete(doc.ref);
                        });
                        
                        return batch.commit();
                    })
                    .then(() => {
                        // Actualizar información del chat
                        return db.collection('chats').doc(chatId).update({
                            lastMessage: 'Chat limpiado',
                            lastMessageAt: firebase.firestore.FieldValue.serverTimestamp(),
                            unreadCount: 0
                        });
                    })
                    .then(() => {
                        showToast('✅ Chat Limpiado', 'Todos los mensajes han sido eliminados', 'success');
                        loadChatMessages(chatId);
                    })
                    .catch((error) => {
                        console.error('Error limpiando chat:', error);
                        showToast('❌ Error', 'No se pudo limpiar el chat', 'error');
                    });
            }
        }

        // Configurar sistema de chat
        function setupChatSystem() {
            // Enviar mensaje con botón
            document.getElementById('btn-send-chat').addEventListener('click', sendChatMessage);
            
            // Enviar mensaje con Enter
            document.getElementById('chat-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendChatMessage();
                }
            });
            
            // Botón de actualizar chats
            document.getElementById('btn-refresh-chats').addEventListener('click', function() {
                loadActiveChats();
                showToast('🔄 Actualizando', 'Lista de chats actualizada', 'info');
            });
            
            // Botón de limpiar chat
            document.getElementById('btn-clear-chat').addEventListener('click', function() {
                if (currentChatId) {
                    clearChat(currentChatId);
                } else {
                    showToast('❌ Error', 'No hay chat seleccionado', 'error');
                }
            });
        }

        // ========== FUNCIONES DEL MODAL DE DETALLES ==========

        function setupModal() {
            const modal = document.getElementById('details-modal');
            const closeBtn = document.getElementById('modal-close');
            
            // Cerrar modal al hacer clic en la X
            closeBtn.addEventListener('click', closeModal);
            
            // Cerrar modal al hacer clic fuera del contenido
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeModal();
                }
            });
            
            // Cerrar modal con tecla ESC
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && modal.classList.contains('active')) {
                    closeModal();
                }
            });
        }

        function openModal() {
            const modal = document.getElementById('details-modal');
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeModal() {
            const modal = document.getElementById('details-modal');
            modal.classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        function showDriverDetails(application) {
            console.log('📋 Mostrando detalles del conductor:', application);
            
            const modalBody = document.getElementById('modal-body');
            
            // Formatear fecha de solicitud
            const appliedDate = application.appliedAt ? 
                application.appliedAt.toDate().toLocaleDateString('es-CO') : 'No disponible';
            
            // Crear contenido del modal
            modalBody.innerHTML = `
                <div class="info-grid">
                    <!-- Información Personal -->
                    <div class="info-section">
                        <div class="info-section-title">
                            <i class="fas fa-user"></i>
                            Información Personal
                        </div>
                        <div class="info-item">
                            <div class="info-label">Nombre Completo</div>
                            <div class="info-value">${application.fullName || 'No especificado'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Número de Cédula</div>
                            <div class="info-value">${application.idNumber || 'No especificado'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Fecha de Nacimiento</div>
                            <div class="info-value">${application.birthDate || 'No especificado'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Email</div>
                            <div class="info-value">${application.email || 'No especificado'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Teléfono</div>
                            <div class="info-value">${application.phone || 'No especificado'}</div>
                        </div>
                    </div>

                    <!-- Información del Vehículo -->
                    <div class="info-section">
                        <div class="info-section-title">
                            <i class="fas fa-car"></i>
                            Información del Vehículo
                        </div>
                        <div class="info-item">
                            <div class="info-label">Marca del Vehículo</div>
                            <div class="info-value">${application.vehicleBrand || 'No especificado'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Año del Vehículo</div>
                            <div class="info-value">${application.vehicleYear || 'No especificado'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Color del Vehículo</div>
                            <div class="info-value">${application.vehicleColor || 'No especificado'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Placa del Vehículo</div>
                            <div class="info-value">${application.vehiclePlate || 'No especificado'}</div>
                        </div>
                    </div>

                    <!-- Información de la Solicitud -->
                    <div class="info-section">
                        <div class="info-section-title">
                            <i class="fas fa-file-alt"></i>
                            Información de la Solicitud
                        </div>
                        <div class="info-item">
                            <div class="info-label">Estado</div>
                            <div class="info-value">
                                <span style="color: var(--warning); font-weight: bold;">
                                    ⏳ Pendiente de Revisión
                                </span>
                            </div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Fecha de Solicitud</div>
                            <div class="info-value">${appliedDate}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">ID de Solicitud</div>
                            <div class="info-value" style="font-family: monospace; font-size: 12px;">
                                ${application.userId || 'No disponible'}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Grid de Fotos Elegante -->
                <div class="photos-grid">
                    <!-- Foto de Perfil -->
                    <div class="photo-section">
                        <div class="photo-title">
                            <i class="fas fa-user-circle"></i>
                            Foto de Perfil
                        </div>
                        <div class="photo-container" onclick="openImageModal('${application.profilePhoto}')">
                            ${application.profilePhoto ? 
                                `<img src="${application.profilePhoto}" alt="Foto de perfil">` :
                                `<div class="photo-placeholder">
                                    <i class="fas fa-user"></i>
                                    <div>No disponible</div>
                                </div>`
                            }
                        </div>
                    </div>

                    <!-- SOAT -->
                    <div class="photo-section">
                        <div class="photo-title">
                            <i class="fas fa-file-medical"></i>
                            SOAT
                        </div>
                        <div class="photo-container" onclick="openImageModal('${application.soat}')">
                            ${application.soat ? 
                                `<img src="${application.soat}" alt="SOAT">` :
                                `<div class="photo-placeholder">
                                    <i class="fas fa-file-medical"></i>
                                    <div>No disponible</div>
                                </div>`
                            }
                        </div>
                    </div>

                    <!-- Tecnomecánica -->
                    <div class="photo-section">
                        <div class="photo-title">
                            <i class="fas fa-file-contract"></i>
                            Tecnomecánica
                        </div>
                        <div class="photo-container" onclick="openImageModal('${application.tecnomecanica}')">
                            ${application.tecnomecanica ? 
                                `<img src="${application.tecnomecanica}" alt="Tecnomecánica">` :
                                `<div class="photo-placeholder">
                                    <i class="fas fa-file-contract"></i>
                                    <div>No disponible</div>
                                </div>`
                            }
                        </div>
                    </div>

                    <!-- Foto del Vehículo -->
                    <div class="photo-section">
                        <div class="photo-title">
                            <i class="fas fa-car-side"></i>
                            Foto del Vehículo
                        </div>
                        <div class="photo-container" onclick="openImageModal('${application.vehiclePhoto}')">
                            ${application.vehiclePhoto ? 
                                `<img src="${application.vehiclePhoto}" alt="Foto del vehículo">` :
                                `<div class="photo-placeholder">
                                    <i class="fas fa-car-side"></i>
                                    <div>No disponible</div>
                                </div>`
                            }
                        </div>
                    </div>
                </div>

                <!-- Acciones -->
                <div style="margin-top: 30px; display: flex; gap: 15px; justify-content: center;">
                    <button class="btn-approve" onclick="approveFromModal('${application.id}', '${application.fullName}')">
                        <i class="fas fa-check"></i> Aprobar Solicitud
                    </button>
                    <button class="btn-reject" onclick="rejectFromModal('${application.id}', '${application.fullName}')">
                        <i class="fas fa-times"></i> Rechazar Solicitud
                    </button>
                </div>
            `;
            
            openModal();
        }

        function openImageModal(imageSrc) {
            if (!imageSrc) {
                showToast('❌ Error', 'No hay imagen disponible para mostrar', 'error');
                return;
            }
            
            // Crear modal de imagen
            const imageModal = document.createElement('div');
            imageModal.className = 'modal-overlay active';
            imageModal.style.zIndex = '1001';
            imageModal.innerHTML = `
                <div class="modal-content" style="max-width: 90%; max-height: 90%;">
                    <div class="modal-header">
                        <div class="modal-title">Vista Previa</div>
                        <button class="modal-close" onclick="this.parentElement.parentElement.parentElement.remove()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div style="padding: 20px; text-align: center;">
                        <img src="${imageSrc}" alt="Imagen ampliada" style="max-width: 100%; max-height: 70vh; border-radius: 8px;">
                    </div>
                </div>
            `;
            
            // Cerrar al hacer clic fuera
            imageModal.addEventListener('click', function(e) {
                if (e.target === imageModal) {
                    imageModal.remove();
                }
            });
            
            document.body.appendChild(imageModal);
        }

        function approveFromModal(docId, userName) {
            closeModal();
            if (confirm(`¿Estás seguro de que deseas APROBAR la solicitud de ${userName}?`)) {
                // Buscar la aplicación para obtener todos los datos
                db.collection('driverApplications').doc(docId).get()
                    .then((doc) => {
                        if (doc.exists) {
                            const application = doc.data();
                            approveDriverApplication(docId, application);
                        }
                    })
                    .catch((error) => {
                        console.error('Error obteniendo aplicación:', error);
                        showToast('❌ Error', 'No se pudo obtener la solicitud', 'error');
                    });
            }
        }

        function rejectFromModal(docId, userName) {
            closeModal();
            if (confirm(`¿Estás seguro de que deseas RECHAZAR la solicitud de ${userName}?`)) {
                rejectDriverApplication(docId, userName);
            }
        }

        // ========== SISTEMA DE GANANCIAS Y COMPROBANTES ==========

        // Cargar estadísticas de ganancias
        function loadEarningsStats() {
            console.log('💰 Cargando estadísticas de ganancias...');
            
            // Ganancias totales de hoy
            db.collection('users')
                .where('isDriverVerified', '==', true)
                .get()
                .then((querySnapshot) => {
                    let totalEarningsToday = 0;
                    querySnapshot.forEach((doc) => {
                        const driver = doc.data();
                        totalEarningsToday += driver.todayEarnings || 0;
                    });
                    document.getElementById('total-earnings-today').textContent = `$${totalEarningsToday.toLocaleString('es-CO')}`;
                })
                .catch((error) => {
                    console.error('Error cargando ganancias de hoy:', error);
                });
            
            // Pagos pendientes
            db.collection('payments')
                .where('status', '==', 'pending_approval')
                .get()
                .then((querySnapshot) => {
                    let totalPaymentsPending = 0;
                    querySnapshot.forEach((doc) => {
                        const payment = doc.data();
                        totalPaymentsPending += payment.amount || 0;
                    });
                    document.getElementById('total-payments-pending').textContent = `$${totalPaymentsPending.toLocaleString('es-CO')}`;
                })
                .catch((error) => {
                    console.error('Error cargando pagos pendientes:', error);
                });
            
            // Comisiones Twogo (10% de las ganancias totales)
            db.collection('users')
                .where('isDriverVerified', '==', true)
                .get()
                .then((querySnapshot) => {
                    let totalComissions = 0;
                    querySnapshot.forEach((doc) => {
                        const driver = doc.data();
                        totalComissions += (driver.todayEarnings || 0) * 0.1;
                    });
                    document.getElementById('total-comissions').textContent = `$${Math.round(totalComissions).toLocaleString('es-CO')}`;
                })
                .catch((error) => {
                    console.error('Error cargando comisiones:', error);
                });
            
            // Comprobantes pendientes
            db.collection('payments')
                .where('status', '==', 'pending_approval')
                .get()
                .then((querySnapshot) => {
                    document.getElementById('total-receipts-pending').textContent = querySnapshot.size;
                })
                .catch((error) => {
                    console.error('Error cargando comprobantes pendientes:', error);
                });
        }

        // Cargar comprobantes pendientes
        function loadPendingReceipts() {
            console.log('🧾 Cargando comprobantes pendientes...');
            const pendingReceiptsList = document.getElementById('pending-receipts-list');
            
            db.collection('payments')
                .where('status', '==', 'pending_approval')
                .orderBy('receiptSubmittedAt', 'desc')
                .get()
                .then((querySnapshot) => {
                    if (querySnapshot.empty) {
                        pendingReceiptsList.innerHTML = `
                            <div class="no-applications">
                                <i class="fas fa-receipt"></i>
                                <div>No hay comprobantes pendientes</div>
                                <small>Todos los comprobantes han sido verificados</small>
                            </div>
                        `;
                        return;
                    }
                    
                    pendingReceiptsList.innerHTML = '';
                    querySnapshot.forEach((doc) => {
                        const payment = doc.data();
                        payment.id = doc.id;
                        const receiptElement = createReceiptElement(payment);
                        pendingReceiptsList.appendChild(receiptElement);
                    });
                })
                .catch((error) => {
                    console.error('Error cargando comprobantes:', error);
                    pendingReceiptsList.innerHTML = `
                        <div class="no-applications">
                            <i class="fas fa-exclamation-triangle"></i>
                            <div>Error cargando comprobantes</div>
                            <small>${error.message}</small>
                        </div>
                    `;
                });
        }

        // Crear elemento de comprobante
        function createReceiptElement(payment) {
            const element = document.createElement('div');
            element.className = 'receipt-item';
            
            // Obtener información del conductor
            db.collection('users').doc(payment.driverId).get()
                .then((driverDoc) => {
                    let driverName = 'Conductor';
                    let driverInitials = 'C';
                    
                    if (driverDoc.exists) {
                        const driverData = driverDoc.data();
                        driverName = driverData.displayName || 'Conductor';
                        driverInitials = driverName.split(' ').map(n => n[0]).join('').toUpperCase();
                    }
                    
                    const submittedDate = payment.receiptSubmittedAt ? 
                        payment.receiptSubmittedAt.toDate().toLocaleDateString('es-CO') : 'Fecha no disponible';
                    
                    element.innerHTML = `
                        <div class="receipt-info">
                            <div class="receipt-avatar">${driverInitials}</div>
                            <div class="receipt-details">
                                <div class="receipt-driver-name">${driverName}</div>
                                <div class="receipt-amount">💰 Monto: $${(payment.amount || 0).toLocaleString('es-CO')}</div>
                                <div class="receipt-date">📅 Enviado: ${submittedDate}</div>
                            </div>
                        </div>
                        <div class="receipt-actions">
                            <button class="btn-view-receipt" data-id="${payment.id}">
                                <i class="fas fa-eye"></i> Ver Comprobante
                            </button>
                            <button class="btn-approve-receipt" data-id="${payment.id}">
                                <i class="fas fa-check"></i> Aprobar
                            </button>
                            <button class="btn-reject-receipt" data-id="${payment.id}">
                                <i class="fas fa-times"></i> Rechazar
                            </button>
                        </div>
                    `;
                    
                    // Event listeners
                    element.querySelector('.btn-view-receipt').addEventListener('click', function() {
                        showReceiptDetails(payment, driverName);
                    });
                    
                    element.querySelector('.btn-approve-receipt').addEventListener('click', function() {
                        approveReceipt(payment.id, driverName);
                    });
                    
                    element.querySelector('.btn-reject-receipt').addEventListener('click', function() {
                        rejectReceipt(payment.id, driverName);
                    });
                })
                .catch((error) => {
                    console.error('Error obteniendo datos del conductor:', error);
                });
            
            return element;
        }

        // Mostrar detalles del comprobante
        function showReceiptDetails(payment, driverName) {
            console.log('📄 Mostrando detalles del comprobante:', payment);
            
            const receiptModalBody = document.getElementById('receipt-modal-body');
            const receiptModal = document.getElementById('receipt-modal');
            
            const submittedDate = payment.receiptSubmittedAt ? 
                payment.receiptSubmittedAt.toDate().toLocaleDateString('es-CO') : 'Fecha no disponible';
            
            receiptModalBody.innerHTML = `
                <div class="receipt-image-container">
                    ${payment.receiptImage ? 
                        `<img src="${payment.receiptImage}" alt="Comprobante de pago" class="receipt-image">` :
                        `<div class="photo-placeholder">
                            <i class="fas fa-receipt"></i>
                            <div>No hay imagen del comprobante</div>
                        </div>`
                    }
                </div>
                
                <div class="receipt-details-grid">
                    <div class="receipt-detail-item">
                        <div class="receipt-detail-label">Conductor</div>
                        <div class="receipt-detail-value">${driverName}</div>
                    </div>
                    <div class="receipt-detail-item">
                        <div class="receipt-detail-label">Monto</div>
                        <div class="receipt-detail-value">$${(payment.amount || 0).toLocaleString('es-CO')}</div>
                    </div>
                    <div class="receipt-detail-item">
                        <div class="receipt-detail-label">Fecha de Envío</div>
                        <div class="receipt-detail-value">${submittedDate}</div>
                    </div>
                    <div class="receipt-detail-item">
                        <div class="receipt-detail-label">Estado</div>
                        <div class="receipt-detail-value">
                            <span style="color: var(--warning); font-weight: bold;">
                                ⏳ Pendiente de Aprobación
                            </span>
                        </div>
                    </div>
                </div>
                
                <div class="receipt-actions-modal">
                    <button class="btn-approve-receipt" onclick="approveReceipt('${payment.id}', '${driverName}')">
                        <i class="fas fa-check"></i> Aprobar Comprobante
                    </button>
                    <button class="btn-reject-receipt" onclick="rejectReceipt('${payment.id}', '${driverName}')">
                        <i class="fas fa-times"></i> Rechazar Comprobante
                    </button>
                </div>
            `;
            
            // Configurar cierre del modal
            const closeBtn = document.getElementById('receipt-modal-close');
            closeBtn.onclick = function() {
                receiptModal.classList.remove('active');
            };
            
            receiptModal.classList.add('active');
        }

        // Aprobar comprobante
        function approveReceipt(paymentId, driverName) {
            if (confirm(`¿Estás seguro de que deseas APROBAR el comprobante de ${driverName}?`)) {
                console.log(`✅ Aprobando comprobante: ${paymentId}`);
                
                db.collection('payments').doc(paymentId).update({
                    status: 'approved',
                    approvedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    approvedBy: auth.currentUser.uid
                })
                .then(() => {
                    showToast('✅ Comprobante Aprobado', `El comprobante de ${driverName} ha sido aprobado`, 'success');
                    
                    // Recargar las listas
                    loadPendingReceipts();
                    loadEarningsStats();
                    updateSidebarCounters();
                    
                    // Cerrar modal si está abierto
                    document.getElementById('receipt-modal').classList.remove('active');
                })
                .catch((error) => {
                    console.error('Error aprobando comprobante:', error);
                    showToast('❌ Error', 'No se pudo aprobar el comprobante: ' + error.message, 'error');
                });
            }
        }

        // Rechazar comprobante
        function rejectReceipt(paymentId, driverName) {
            if (confirm(`¿Estás seguro de que deseas RECHAZAR el comprobante de ${driverName}?`)) {
                console.log(`❌ Rechazando comprobante: ${paymentId}`);
                
                db.collection('payments').doc(paymentId).update({
                    status: 'rejected',
                    rejectedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    rejectedBy: auth.currentUser.uid,
                    rejectionReason: 'Rechazado por administrador'
                })
                .then(() => {
                    showToast('Comprobante Rechazado', `El comprobante de ${driverName} ha sido rechazado`, 'warning');
                    
                    // Recargar las listas
                    loadPendingReceipts();
                    loadEarningsStats();
                    updateSidebarCounters();
                    
                    // Cerrar modal si está abierto
                    document.getElementById('receipt-modal').classList.remove('active');
                })
                .catch((error) => {
                    console.error('Error rechazando comprobante:', error);
                    showToast('❌ Error', 'No se pudo rechazar el comprobante', 'error');
                });
            }
        }

        // ========== SISTEMA DE SOLICITUDES DE CRÉDITOS ==========

        // Cargar solicitudes de cobro de créditos
        function loadPendingCreditsRequests() {
            console.log('💰 Cargando solicitudes de créditos...');
            const pendingCreditsList = document.getElementById('pending-credits-list');
            
            db.collection('paymentRequests')
                .where('status', '==', 'pending')
                .where('type', '==', 'credits_payment')
                .orderBy('requestedAt', 'desc')
                .get()
                .then((querySnapshot) => {
                    if (querySnapshot.empty) {
                        pendingCreditsList.innerHTML = `
                            <div class="no-applications">
                                <i class="fas fa-coins"></i>
                                <div>No hay solicitudes de créditos pendientes</div>
                                <small>Las solicitudes de cobro aparecerán aquí</small>
                            </div>
                        `;
                        return;
                    }
                    
                    pendingCreditsList.innerHTML = '';
                    querySnapshot.forEach((doc) => {
                        const request = doc.data();
                        request.id = doc.id;
                        const requestElement = createCreditsRequestElement(request);
                        pendingCreditsList.appendChild(requestElement);
                    });
                })
                .catch((error) => {
                    console.error('Error cargando solicitudes de créditos:', error);
                    pendingCreditsList.innerHTML = `
                        <div class="no-applications">
                            <i class="fas fa-exclamation-triangle"></i>
                            <div>Error cargando solicitudes de créditos</div>
                            <small>${error.message}</small>
                        </div>
                    `;
                });
        }

        // Crear elemento de solicitud de créditos
        function createCreditsRequestElement(request) {
            const element = document.createElement('div');
            element.className = 'credits-request-item';
            
            // Obtener información del conductor
            db.collection('users').doc(request.driverId).get()
                .then((driverDoc) => {
                    let driverName = 'Conductor';
                    let driverInitials = 'C';
                    
                    if (driverDoc.exists) {
                        const driverData = driverDoc.data();
                        driverName = driverData.displayName || 'Conductor';
                        driverInitials = driverName.split(' ').map(n => n[0]).join('').toUpperCase();
                    }
                    
                    const requestedDate = request.requestedAt ? 
                        new Date(request.requestedAt).toLocaleDateString('es-CO') : 'Fecha no disponible';
                    
                    element.innerHTML = `
                        <div class="credits-request-info">
                            <div class="credits-request-avatar">${driverInitials}</div>
                            <div class="credits-request-details">
                                <div class="credits-request-driver-name">${driverName}</div>
                                <div class="credits-request-amount">💰 Monto: $${(request.amount || 0).toLocaleString('es-CO')}</div>
                                <div class="credits-request-account">🏦 ${request.accountType || ''}: ${request.accountNumber || ''}</div>
                                <div class="credits-request-date">📅 Solicitado: ${requestedDate}</div>
                            </div>
                        </div>
                        <div class="credits-request-actions">
                            <button class="btn-view-credits-details" data-id="${request.id}">
                                <i class="fas fa-eye"></i> Ver Detalles
                            </button>
                            <button class="btn-approve-credits" data-id="${request.id}">
                                <i class="fas fa-check"></i> Aprobar
                            </button>
                            <button class="btn-reject-credits" data-id="${request.id}">
                                <i class="fas fa-times"></i> Rechazar
                            </button>
                        </div>
                    `;
                    
                    // Event listeners
                    element.querySelector('.btn-view-credits-details').addEventListener('click', function() {
                        showCreditsRequestDetails(request, driverName);
                    });
                    
                    element.querySelector('.btn-approve-credits').addEventListener('click', function() {
                        approveCreditsRequest(request.id, driverName, request.amount);
                    });
                    
                    element.querySelector('.btn-reject-credits').addEventListener('click', function() {
                        rejectCreditsRequest(request.id, driverName);
                    });
                })
                .catch((error) => {
                    console.error('Error obteniendo datos del conductor:', error);
                });
            
            return element;
        }

        // Mostrar detalles de la solicitud de créditos
        function showCreditsRequestDetails(request, driverName) {
            console.log('💰 Mostrando detalles de solicitud de créditos:', request);
            
            const creditsModalBody = document.getElementById('credits-modal-body');
            const creditsModal = document.getElementById('credits-modal');
            
            const requestedDate = request.requestedAt ? 
                new Date(request.requestedAt).toLocaleDateString('es-CO') : 'Fecha no disponible';
            
            creditsModalBody.innerHTML = `
                <div class="credits-details-grid">
                    <div class="credits-detail-item">
                        <div class="credits-detail-label">Conductor</div>
                        <div class="credits-detail-value">${driverName}</div>
                    </div>
                    <div class="credits-detail-item">
                        <div class="credits-detail-label">Email</div>
                        <div class="credits-detail-value">${request.driverEmail || 'No disponible'}</div>
                    </div>
                    <div class="credits-detail-item">
                        <div class="credits-detail-label">Monto Solicitado</div>
                        <div class="credits-detail-value">$${(request.amount || 0).toLocaleString('es-CO')}</div>
                    </div>
                    <div class="credits-detail-item">
                        <div class="credits-detail-label">Tipo de Cuenta</div>
                        <div class="credits-detail-value">${request.accountType || 'No especificado'}</div>
                    </div>
                    <div class="credits-detail-item">
                        <div class="credits-detail-label">Número de Cuenta</div>
                        <div class="credits-detail-value">${request.accountNumber || 'No especificado'}</div>
                    </div>
                    <div class="credits-detail-item">
                        <div class="credits-detail-label">Fecha de Solicitud</div>
                        <div class="credits-detail-value">${requestedDate}</div>
                    </div>
                    <div class="credits-detail-item">
                        <div class="credits-detail-label">Estado</div>
                        <div class="credits-detail-value">
                            <span style="color: var(--warning); font-weight: bold;">
                                ⏳ Pendiente de Aprobación
                            </span>
                        </div>
                    </div>
                </div>
                
                <div class="credits-actions-modal">
                    <button class="btn-approve-credits" onclick="approveCreditsRequest('${request.id}', '${driverName}', ${request.amount})">
                        <i class="fas fa-check"></i> Aprobar Pago
                    </button>
                    <button class="btn-reject-credits" onclick="rejectCreditsRequest('${request.id}', '${driverName}')">
                        <i class="fas fa-times"></i> Rechazar Solicitud
                    </button>
                </div>
            `;
            
            // Configurar cierre del modal
            const closeBtn = document.getElementById('credits-modal-close');
            closeBtn.onclick = function() {
                creditsModal.classList.remove('active');
            };
            
            creditsModal.classList.add('active');
        }

        // Aprobar solicitud de créditos
        function approveCreditsRequest(requestId, driverName, amount) {
            if (confirm(`¿Estás seguro de que deseas APROBAR el pago de $${amount.toLocaleString('es-CO')} a ${driverName}?`)) {
                console.log(`✅ Aprobando solicitud de créditos: ${requestId}`);
                
                db.collection('paymentRequests').doc(requestId).update({
                    status: 'approved',
                    approvedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    approvedBy: auth.currentUser.uid
                })
                .then(() => {
                    showToast('✅ Pago Aprobado', `Se ha aprobado el pago de $${amount.toLocaleString('es-CO')} a ${driverName}`, 'success');
                    
                    // Recargar las listas
                    loadPendingCreditsRequests();
                    updateSidebarCounters();
                    
                    // Cerrar modal si está abierto
                    document.getElementById('credits-modal').classList.remove('active');
                    
                    // Enviar notificación al conductor
                    sendNotificationToDriver(requestId, 'approved', amount);
                })
                .catch((error) => {
                    console.error('Error aprobando solicitud de créditos:', error);
                    showToast('❌ Error', 'No se pudo aprobar la solicitud: ' + error.message, 'error');
                });
            }
        }

        // Rechazar solicitud de créditos
        function rejectCreditsRequest(requestId, driverName) {
            const reason = prompt(`Ingresa el motivo por el cual rechazas la solicitud de ${driverName}:`);
            
            if (reason === null) {
                return; // Usuario canceló
            }
            
            if (!reason.trim()) {
                showToast('❌ Error', 'Debes ingresar un motivo para rechazar la solicitud', 'error');
                return;
            }
            
            if (confirm(`¿Estás seguro de que deseas RECHAZAR la solicitud de ${driverName}?`)) {
                console.log(`❌ Rechazando solicitud de créditos: ${requestId}`);
                
                db.collection('paymentRequests').doc(requestId).update({
                    status: 'rejected',
                    rejectedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    rejectedBy: auth.currentUser.uid,
                    rejectionReason: reason
                })
                .then(() => {
                    showToast('Solicitud Rechazada', `La solicitud de ${driverName} ha sido rechazada`, 'warning');
                    
                    // Recargar las listas
                    loadPendingCreditsRequests();
                    updateSidebarCounters();
                    
                    // Cerrar modal si está abierto
                    document.getElementById('credits-modal').classList.remove('active');
                    
                    // Enviar notificación al conductor
                    sendNotificationToDriver(requestId, 'rejected', 0, reason);
                })
                .catch((error) => {
                    console.error('Error rechazando solicitud de créditos:', error);
                    showToast('❌ Error', 'No se pudo rechazar la solicitud', 'error');
                });
            }
        }

        // Enviar notificación al conductor sobre el estado de su solicitud
        function sendNotificationToDriver(requestId, status, amount, reason = '') {
            // Obtener los datos de la solicitud
            db.collection('paymentRequests').doc(requestId).get()
                .then((doc) => {
                    if (doc.exists) {
                        const request = doc.data();
                        const driverId = request.driverId;
                        
                        let title = '';
                        let message = '';
                        
                        if (status === 'approved') {
                            title = '✅ Pago Aprobado';
                            message = `Tu solicitud de cobro de $${amount.toLocaleString('es-CO')} ha sido aprobada. El pago será procesado en los próximos días.`;
                        } else {
                            title = '❌ Solicitud Rechazada';
                            message = `Tu solicitud de cobro ha sido rechazada. Motivo: ${reason}`;
                        }
                        
                        // Guardar notificación para el conductor
                        return db.collection('userNotifications').add({
                            userId: driverId,
                            type: 'payment_request',
                            title: title,
                            message: message,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            read: false
                        });
                    }
                })
                .then(() => {
                    console.log('✅ Notificación enviada al conductor');
                })
                .catch((error) => {
                    console.error('Error enviando notificación al conductor:', error);
                });
        }

        // ========== FUNCIONES DEL PANEL DE ADMINISTRACIÓN ==========

        // Cargar estadísticas del dashboard
        function loadDashboardStats() {
            console.log('📊 Cargando estadísticas...');
            
            // Usuarios totales
            db.collection('users').get()
                .then((querySnapshot) => {
                    document.getElementById('total-users').textContent = querySnapshot.size.toLocaleString();
                })
                .catch((error) => {
                    console.error('Error cargando usuarios:', error);
                });
            
            // Conductores activos
            db.collection('users')
                .where('isDriverVerified', '==', true)
                .where('isOnline', '==', true)
                .get()
                .then((querySnapshot) => {
                    document.getElementById('active-drivers').textContent = querySnapshot.size.toLocaleString();
                })
                .catch((error) => {
                    console.error('Error cargando conductores activos:', error);
                });
            
            // Viajes hoy
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            db.collection('rideRequests')
                .where('completedAt', '>=', today)
                .get()
                .then((querySnapshot) => {
                    document.getElementById('today-rides').textContent = querySnapshot.size.toLocaleString();
                })
                .catch((error) => {
                    console.error('Error cargando viajes de hoy:', error);
                });
            
            // Ganancias totales
            db.collection('rideRequests')
                .where('status', '==', 'completed')
                .get()
                .then((querySnapshot) => {
                    let totalEarnings = 0;
                    querySnapshot.forEach((doc) => {
                        const ride = doc.data();
                        totalEarnings += ride.price || 0;
                    });
                    document.getElementById('total-earnings').textContent = `$${(totalEarnings).toLocaleString('es-CO')}`;
                })
                .catch((error) => {
                    console.error('Error cargando ganancias:', error);
                });
        }

        // Cargar solicitudes de conductores pendientes
        function loadPendingDriverApplications() {
            console.log('👥 Cargando solicitudes pendientes...');
            const pendingList = document.getElementById('pending-drivers-list');
            
            db.collection('driverApplications')
                .where('status', '==', 'pending')
                .orderBy('appliedAt', 'desc')
                .get()
                .then((querySnapshot) => {
                    if (querySnapshot.empty) {
                        pendingList.innerHTML = `
                            <div class="no-applications">
                                <i class="fas fa-user-clock"></i>
                                <div>No hay solicitudes pendientes</div>
                                <small>Todas las solicitudes han sido procesadas</small>
                            </div>
                        `;
                        return;
                    }
                    
                    pendingList.innerHTML = '';
                    querySnapshot.forEach((doc) => {
                        const application = doc.data();
                        application.id = doc.id; // Agregar el ID del documento
                        const applicationElement = createDriverApplicationElement(application, doc.id);
                        pendingList.appendChild(applicationElement);
                    });
                })
                .catch((error) => {
                    console.error('Error cargando solicitudes:', error);
                    pendingList.innerHTML = `
                        <div class="no-applications">
                            <i class="fas fa-exclamation-triangle"></i>
                            <div>Error cargando solicitudes</div>
                            <small>${error.message}</small>
                        </div>
                    `;
                });
        }

        // Crear elemento de solicitud de conductor CON BOTÓN VER DETALLES
        function createDriverApplicationElement(application, docId) {
            const element = document.createElement('div');
            element.className = 'driver-application';
            
            const initials = application.fullName ? 
                application.fullName.split(' ').map(n => n[0]).join('').toUpperCase() : 'U';
            
            const appliedDate = application.appliedAt ? 
                application.appliedAt.toDate().toLocaleDateString('es-CO') : 'Fecha no disponible';

            element.innerHTML = `
                <div class="driver-app-info">
                    <div class="driver-app-avatar">${initials}</div>
                    <div class="driver-app-details">
                        <div class="driver-app-name">${application.fullName || 'No especificado'}</div>
                        <div class="driver-app-phone">📱 ${application.phone || 'No especificado'}</div>
                        <div class="driver-app-email">📧 ${application.email || 'No especificado'}</div>
                        <div class="driver-app-vehicle">🚗 ${application.vehicleBrand || ''} ${application.vehicleYear || ''} - ${application.vehiclePlate || ''}</div>
                        <small>Solicitado: ${appliedDate}</small>
                    </div>
                </div>
                <div class="driver-app-actions">
                    <button class="btn-view-details" data-id="${docId}">
                        <i class="fas fa-eye"></i> Ver Detalles
                    </button>
                    <button class="btn-approve" data-id="${docId}">
                        <i class="fas fa-check"></i> Aprobar
                    </button>
                    <button class="btn-reject" data-id="${docId}">
                        <i class="fas fa-times"></i> Rechazar
                    </button>
                </div>
            `;
            
            // Event listeners
            element.querySelector('.btn-view-details').addEventListener('click', function() {
                showDriverDetails(application);
            });
            
            element.querySelector('.btn-approve').addEventListener('click', function() {
                approveDriverApplication(docId, application);
            });
            
            element.querySelector('.btn-reject').addEventListener('click', function() {
                rejectDriverApplication(docId, application.fullName);
            });
            
            return element;
        }

        // Aprobar solicitud de conductor
        function approveDriverApplication(docId, application) {
            if (confirm(`¿Estás seguro de que deseas APROBAR la solicitud de ${application.fullName}?`)) {
                console.log(`✅ Aprobando solicitud: ${docId}`);
                
                // Actualizar estado de la solicitud
                db.collection('driverApplications').doc(docId).update({
                    status: 'approved',
                    approvedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    approvedBy: auth.currentUser.uid
                })
                .then(() => {
                    console.log('✅ Solicitud aprobada en driverApplications');
                    
                    // Actualizar estado del usuario
                    return db.collection('users').doc(application.userId).update({
                        isDriverVerified: true,
                        verificationStatus: 'approved',
                        vehicleBrand: application.vehicleBrand,
                        vehicleYear: application.vehicleYear,
                        vehicleColor: application.vehicleColor,
                        vehiclePlate: application.vehiclePlate,
                        vehiclePhoto: application.vehiclePhoto,
                        displayName: application.fullName
                    });
                })
                .then(() => {
                    console.log('✅ Usuario actualizado como conductor verificado');
                    showToast('✅ Solicitud Aprobada', `${application.fullName} ha sido verificado como conductor`, 'success');
                    
                    // Recargar las listas
                    loadPendingDriverApplications();
                    loadVerifiedDrivers();
                    loadDashboardStats();
                    updateSidebarCounters();
                    
                    // Enviar notificación push al conductor
                    sendPushNotification(
                        '🎉 ¡Felicidades!', 
                        `Tu solicitud como conductor ha sido aprobada. Ya puedes comenzar a trabajar con Twogo.`,
                        'drivers',
                        { type: 'driver_approved', driverId: application.userId }
                    );
                })
                .catch((error) => {
                    console.error('❌ Error aprobando solicitud:', error);
                    showToast('❌ Error', 'No se pudo aprobar la solicitud: ' + error.message, 'error');
                });
            }
        }

        // Rechazar solicitud de conductor
        function rejectDriverApplication(docId, driverName) {
            if (confirm(`¿Estás seguro de que deseas RECHAZAR la solicitud de ${driverName}?`)) {
                console.log(`❌ Rechazando solicitud: ${docId}`);
                
                db.collection('driverApplications').doc(docId).update({
                    status: 'rejected',
                    rejectedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    rejectedBy: auth.currentUser.uid
                })
                .then(() => {
                    showToast('Solicitud Rechazada', `La solicitud de ${driverName} ha sido rechazada`, 'warning');
                    loadPendingDriverApplications();
                    updateSidebarCounters();
                })
                .catch((error) => {
                    console.error('Error rechazando solicitud:', error);
                    showToast('❌ Error', 'No se pudo rechazar la solicitud', 'error');
                });
            }
        }

        // Cargar conductores verificados
        function loadVerifiedDrivers() {
            console.log('🚗 Cargando conductores verificados...');
            const verifiedList = document.getElementById('verified-drivers-list');
            
            db.collection('users')
                .where('isDriverVerified', '==', true)
                .get()
                .then((querySnapshot) => {
                    if (querySnapshot.empty) {
                        verifiedList.innerHTML = `
                            <div class="no-applications">
                                <i class="fas fa-user-check"></i>
                                <div>No hay conductores verificados</div>
                                <small>Los conductores aparecerán aquí una vez sean aprobados</small>
                            </div>
                        `;
                        return;
                    }
                    
                    verifiedList.innerHTML = '';
                    querySnapshot.forEach((doc) => {
                        const driver = doc.data();
                        const driverElement = createVerifiedDriverElement(driver, doc.id);
                        verifiedList.appendChild(driverElement);
                    });
                })
                .catch((error) => {
                    console.error('Error cargando conductores:', error);
                    verifiedList.innerHTML = `
                        <div class="no-applications">
                            <i class="fas fa-exclamation-triangle"></i>
                            <div>Error cargando conductores</div>
                            <small>${error.message}</small>
                        </div>
                    `;
                });
        }

        // Crear elemento de conductor verificado
        function createVerifiedDriverElement(driver, docId) {
            const element = document.createElement('div');
            element.className = 'verified-driver-card';
            
            const initials = driver.displayName ? 
                driver.displayName.split(' ').map(n => n[0]).join('').toUpperCase() : 'U';
            
            const status = driver.isOnline ? 'online' : 'offline';
            const statusText = driver.isOnline ? 'En línea' : 'Desconectado';

            element.innerHTML = `
                <div class="verified-driver-avatar">${initials}</div>
                <div class="verified-driver-name">${driver.displayName || 'Usuario'}</div>
                <div class="verified-driver-email">${driver.email || 'No especificado'}</div>
                <div class="verified-driver-vehicle">${driver.vehicleBrand || ''} ${driver.vehicleYear || ''}</div>
                <div class="verified-driver-plate">Placa: ${driver.vehiclePlate || 'Sin placa'}</div>
                <div class="verified-driver-status ${status}">
                    <i class="fas fa-circle"></i> ${statusText}
                </div>
                <button class="btn-revoke" data-id="${docId}">
                    <i class="fas fa-ban"></i> Revocar Verificación
                </button>
            `;
            
            element.querySelector('.btn-revoke').addEventListener('click', function() {
                revokeDriverVerification(docId, driver.displayName);
            });
            
            return element;
        }

        // Revocar verificación de conductor
        function revokeDriverVerification(docId, driverName) {
            if (confirm(`¿Estás seguro de que deseas REVOCAR la verificación de ${driverName}?`)) {
                console.log(`🚫 Revocando verificación: ${docId}`);
                
                db.collection('users').doc(docId).update({
                    isDriverVerified: false,
                    verificationStatus: 'revoked',
                    revokedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    revokedBy: auth.currentUser.uid
                })
                .then(() => {
                    showToast('Verificación Revocada', `La verificación de ${driverName} ha sido revocada`, 'warning');
                    loadVerifiedDrivers();
                    loadDashboardStats();
                })
                .catch((error) => {
                    console.error('Error revocando verificación:', error);
                    showToast('❌ Error', 'No se pudo revocar la verificación', 'error');
                });
            }
        }

        // Cargar lista negra
        function loadBlacklist() {
            console.log('⚫ Cargando lista negra...');
            const blacklistItems = document.getElementById('blacklist-items');
            
            db.collection('blacklist')
                .orderBy('addedAt', 'desc')
                .get()
                .then((querySnapshot) => {
                    if (querySnapshot.empty) {
                        blacklistItems.innerHTML = `
                            <div class="no-applications">
                                <i class="fas fa-ban"></i>
                                <div>No hay placas en lista negra</div>
                                <small>Las placas agregadas aparecerán aquí</small>
                            </div>
                        `;
                        return;
                    }
                    
                    blacklistItems.innerHTML = '';
                    querySnapshot.forEach((doc) => {
                        const item = doc.data();
                        const itemElement = createBlacklistItemElement(item, doc.id);
                        blacklistItems.appendChild(itemElement);
                    });
                })
                .catch((error) => {
                    console.error('Error cargando lista negra:', error);
                    blacklistItems.innerHTML = `
                        <div class="no-applications">
                            <i class="fas fa-exclamation-triangle"></i>
                            <div>Error cargando lista negra</div>
                            <small>${error.message}</small>
                        </div>
                    `;
                });
        }

        // Crear elemento de lista negra
        function createBlacklistItemElement(item, docId) {
            const element = document.createElement('div');
            element.className = 'blacklist-item';
            
            const addedDate = item.addedAt ? 
                item.addedAt.toDate().toLocaleDateString('es-CO') : 'Fecha no disponible';

            element.innerHTML = `
                <div>
                    <div class="blacklist-plate">🚫 ${item.plate}</div>
                    <div class="blacklist-reason">${item.reason || 'Sin motivo especificado'}</div>
                    <small>Agregado: ${addedDate}</small>
                </div>
                <button class="btn-remove-blacklist" data-id="${docId}">
                    <i class="fas fa-trash"></i> Eliminar
                </button>
            `;
            
            element.querySelector('.btn-remove-blacklist').addEventListener('click', function() {
                removeFromBlacklist(docId, item.plate);
            });
            
            return element;
        }

        // Agregar a lista negra
        function setupBlacklist() {
            document.getElementById('btn-add-blacklist').addEventListener('click', function() {
                const plate = document.getElementById('blacklist-plate').value.toUpperCase().trim();
                const reason = document.getElementById('blacklist-reason').value.trim();
                
                if (!plate) {
                    showToast('❌ Error', 'Por favor, ingresa una placa', 'error');
                    return;
                }
                
                if (!reason) {
                    showToast('❌ Error', 'Por favor, ingresa un motivo', 'error');
                    return;
                }
                
                if (plate.length < 6) {
                    showToast('❌ Error', 'La placa debe tener al menos 6 caracteres', 'error');
                    return;
                }
                
                // Verificar si la placa ya está en lista negra
                db.collection('blacklist')
                    .where('plate', '==', plate)
                    .get()
                    .then((querySnapshot) => {
                        if (!querySnapshot.empty) {
                            showToast('❌ Error', 'Esta placa ya está en lista negra', 'error');
                            return;
                        }
                        
                        // Agregar a lista negra
                        return db.collection('blacklist').add({
                            plate: plate,
                            reason: reason,
                            addedBy: auth.currentUser.uid,
                            addedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    })
                    .then(() => {
                        showToast('✅ Placa Agregada', `La placa ${plate} ha sido agregada a la lista negra`, 'success');
                        document.getElementById('blacklist-plate').value = '';
                        document.getElementById('blacklist-reason').value = '';
                        loadBlacklist();
                    })
                    .catch((error) => {
                        console.error('Error agregando a lista negra:', error);
                        showToast('❌ Error', 'No se pudo agregar a lista negra: ' + error.message, 'error');
                    });
            });
        }

        // Eliminar de lista negra
        function removeFromBlacklist(docId, plate) {
            if (confirm(`¿Estás seguro de que deseas ELIMINAR la placa ${plate} de la lista negra?`)) {
                db.collection('blacklist').doc(docId).delete()
                    .then(() => {
                        showToast('✅ Placa Eliminada', `La placa ${plate} ha sido eliminada de la lista negra`, 'success');
                        loadBlacklist();
                    })
                    .catch((error) => {
                        console.error('Error eliminando de lista negra:', error);
                        showToast('❌ Error', 'No se pudo eliminar de lista negra', 'error');
                    });
            }
        }

        // Configurar sistema de notificaciones
        function setupNotificationSystem() {
            // Cambiar target de notificación
            document.querySelectorAll('.notification-target').forEach(target => {
                target.addEventListener('click', function() {
                    document.querySelectorAll('.notification-target').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                });
            });
            
            // Enviar notificación
            document.getElementById('btn-send-notification').addEventListener('click', function() {
                const message = document.getElementById('notification-message').value.trim();
                const target = document.querySelector('.notification-target.active').getAttribute('data-target');
                
                if (!message) {
                    showToast('❌ Error', 'Por favor, escribe un mensaje de notificación', 'error');
                    return;
                }
                
                if (message.length < 5) {
                    showToast('❌ Error', 'El mensaje debe tener al menos 5 caracteres', 'error');
                    return;
                }
                
                sendNotificationToUsers(message, target);
            });
        }

        // Enviar notificación a usuarios
        function sendNotificationToUsers(message, target) {
            console.log(`📢 Enviando notificación: ${message} a ${target}`);
            
            let targetText = '';
            switch(target) {
                case 'all':
                    targetText = 'todos los usuarios';
                    break;
                case 'passengers':
                    targetText = 'solo pasajeros';
                    break;
                case 'drivers':
                    targetText = 'solo conductores';
                    break;
            }
            
            // Guardar notificación en Firestore
            const notificationData = {
                message: message,
                target: target,
                sentBy: auth.currentUser.uid,
                sentAt: firebase.firestore.FieldValue.serverTimestamp(),
                sentTo: targetText
            };
            
            db.collection('adminNotifications').add(notificationData)
                .then(() => {
                    showToast('✅ Notificación Enviada', `Se ha enviado la notificación a ${targetText}`, 'success');
                    document.getElementById('notification-message').value = '';
                    
                    // Enviar notificación push
                    const title = '📢 Twogo Notificación';
                    sendPushNotification(title, message, target);
                })
                .catch((error) => {
                    console.error('Error enviando notificación:', error);
                    showToast('❌ Error', 'No se pudo enviar la notificación', 'error');
                });
        }

        // ========== INICIALIZACIÓN ==========

        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Inicializando panel de administración...');
            
            // Configurar el modal primero
            setupModal();
            
            // Configurar modales adicionales
            setupAdditionalModals();
            
            // Configurar sistema de chat
            setupChatSystem();
            
            // Configurar navegación
            setupNavigation();
            
            // Configurar sistemas
            setupNotificationSystem();
            setupBlacklist();
            
            // Verificar autenticación
            auth.onAuthStateChanged((user) => {
                if (user) {
                    console.log('✅ Usuario autenticado:', user.email);
                    
                    // Actualizar información del usuario
                    document.getElementById('user-avatar').textContent = 
                        user.email.substring(0, 1).toUpperCase();
                    document.getElementById('user-name').textContent = user.email;
                    
                    // Verificar si es administrador
                    db.collection('users').doc(user.uid).get()
                        .then((doc) => {
                            if (doc.exists) {
                                const userData = doc.data();
                                if (userData.isAdmin || user.email === 'thecam35@gmail.com') {
                                    console.log('🎯 Usuario es administrador');
                                    adminData = userData;
                                    initializeAdminPanel();
                                } else {
                                    console.log('❌ Usuario no es administrador');
                                    showToast('❌ Acceso Denegado', 'No tienes permisos de administrador', 'error');
                                    setTimeout(() => {
                                        window.location.href = 'index.html';
                                    }, 3000);
                                }
                            }
                        })
                        .catch((error) => {
                            console.error('Error verificando permisos:', error);
                            showToast('❌ Error', 'Error verificando permisos', 'error');
                        });
                } else {
                    console.log('❌ Usuario no autenticado');
                    showToast('🔐 Inicia Sesión', 'Debes iniciar sesión como administrador', 'warning');
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 3000);
                }
            });
        });

        function setupAdditionalModals() {
            // Configurar modal de créditos
            const creditsModal = document.getElementById('credits-modal');
            const creditsCloseBtn = document.getElementById('credits-modal-close');
            
            creditsCloseBtn.addEventListener('click', function() {
                creditsModal.classList.remove('active');
            });
            
            creditsModal.addEventListener('click', function(e) {
                if (e.target === creditsModal) {
                    creditsModal.classList.remove('active');
                }
            });
            
            // Configurar modal de comprobantes
            const receiptModal = document.getElementById('receipt-modal');
            const receiptCloseBtn = document.getElementById('receipt-modal-close');
            
            receiptCloseBtn.addEventListener('click', function() {
                receiptModal.classList.remove('active');
            });
            
            receiptModal.addEventListener('click', function(e) {
                if (e.target === receiptModal) {
                    receiptModal.classList.remove('active');
                }
            });
        }

        function initializeAdminPanel() {
            console.log('🛠️ Inicializando componentes del panel...');
            
            // Cargar todos los datos iniciales
            loadDashboardStats();
            loadEarningsStats();
            loadPendingReceipts();
            loadPendingCreditsRequests();
            loadActiveChats();
            loadPendingDriverApplications();
            loadVerifiedDrivers();
            loadBlacklist();
            
            // Actualizar contadores
            updateSidebarCounters();
            
            // Configurar actualizaciones en tiempo real
            setupRealTimeListeners();
            
            showToast('✅ Panel Listo', 'Panel de administración cargado correctamente', 'success');
        }

        // Configurar listeners en tiempo real
        function setupRealTimeListeners() {
            console.log('🔄 Configurando listeners en tiempo real...');
            
            // Listener para solicitudes pendientes
            db.collection('driverApplications')
                .where('status', '==', 'pending')
                .onSnapshot((snapshot) => {
                    loadPendingDriverApplications();
                    updateSidebarCounters();
                });
            
            // Listener para conductores verificados
            db.collection('users')
                .where('isDriverVerified', '==', true)
                .onSnapshot((snapshot) => {
                    loadVerifiedDrivers();
                    loadDashboardStats();
                });
            
            // Listener para comprobantes pendientes
            db.collection('payments')
                .where('status', '==', 'pending_approval')
                .onSnapshot((snapshot) => {
                    loadPendingReceipts();
                    loadEarningsStats();
                    updateSidebarCounters();
                });
            
            // Listener para solicitudes de créditos
            db.collection('paymentRequests')
                .where('status', '==', 'pending')
                .where('type', '==', 'credits_payment')
                .onSnapshot((snapshot) => {
                    loadPendingCreditsRequests();
                    updateSidebarCounters();
                });
        }
    </script>
</body>

</html>


